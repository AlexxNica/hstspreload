<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=0.5">
  <title>HSTS Preload Submission</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>

<div class="ribbon"></div>
<div class="content submission">

  <div class="inner-content">
    <div class="crumbs">
      HSTS &gt; Preload List &gt; Submit
    </div>
  </div>

  <div id="entry">
    <h2>Enter a domain to include in the HSTS preload list:</h2>
    <input id="textinput" onkeypress="keypress(event)" type="text" placeholder="example.com" autofocus></input>

    <p id="error"></p>
    <div id="msg"></div>
  </div>

  <div class="inner-content">

    <h2>
      Information
    </h2>

    <div id="text">
                  <p>This form is used to submit domains for inclusion in Chrome's <a href="https://en.wikipedia.org/wiki/HTTP_Strict_Transport_Security">HTTP Strict Transport Security (HSTS)</a> preload list. This is a list of sites that are hardcoded into Chrome as being HTTPS only. <a href="https://blog.mozilla.org/security/2012/11/01/preloading-hsts/">Firefox</a>, Safari, <a href="https://blogs.windows.com/msedgedev/2015/06/09/http-strict-transport-security-comes-to-internet-explorer-11-on-windows-8-1-and-windows-7/">IE 11 and Edge</a> also have HSTS preload lists which include the Chrome list. (See the <a href="http://caniuse.com/#feat=stricttransportsecurity">HSTS compatibility matrix</a>.)</p>

    <h2>
      Requirements
    </h2>

      <p>In order to be included on the HSTS preload list through this form, your site must:</p>
      <ol>
        <li>Have a valid certificate.</li>
        <li>Redirect all HTTP traffic to HTTPS&mdash;i.e. be HTTPS only.</li>
        <li>Serve all subdomains over HTTPS, specifically including the <tt>www</tt> subdomain if a DNS record for that subdomain exists.</li>
        <li>Serve an HSTS header on the base domain for HTTPS requests:
          <ul>
            <li>Expiry must be at least eighteen weeks (10886400 seconds).</li>
            <li>The <tt>includeSubDomains</tt> token must be specified.</li>
            <li>The <tt>preload</tt> token must be specified.</li>
            <li>If you are serving an additional redirect from your HTTPS site, that redirect must still have the HSTS header (not the page it redirects to).</li>
          </ul>
        </li>
      </ol>

      <p>For more details on HSTS, please see <a href="https://tools.ietf.org/html/rfc6797">RFC 6797</a>. Note that the <tt>preload</tt> flag in the HSTS header is required to confirm and authenticate your submission to the preload list. An example valid HSTS header:</p>
      <p><tt>Strict-Transport-Security: max-age=10886400; includeSubDomains; preload</tt></p>

    <h2>
      Conditions
    </h2>

      <p>Be aware that inclusion in the preload list cannot really be undone. You can request to be removed, but it will take months for the deleted entry to reach users with a Chrome update and we cannot make guarantees about other browser vendors. Don't request inclusion unless you're sure that you can support HTTPS for the long term.</p>

      <p>Submissions to the preload list are not automatic nor assured. All submissions undergo a manual review that may take one to several weeks. You can check the status of your request by entering the domain name again in the form above, or consult the current Chrome preload list by visiting <tt>chrome://net-internals/#hsts</tt> in your browser. Note that new entries are submitted to the Chrome source code and can take several months before they reach the stable version.</p>

      <p>If you have questions or requests that are not covered by this page, email Lucas Garron at <a href="mailto:hstspreload@chromium.org">hstspreload@chromium.org</a>.</p>

    </div>
  </div>

</div>

<script>
var requestedDomain = "";

function keypress(e) {
  var code = (e.keyCode ? e.keyCode : e.which);
  if (code != 13) {
    return;
  }

  var textInput = document.getElementById("textinput");
  textInput.disabled = true;
  var domain = textInput.value;

  clearOutput();

  if (domain.indexOf(":") != -1) {
    var parser = document.createElement('a');
    parser.href = domain;
    domain = parser.hostname;
  }

  if (domain === undefined || domain.length < 1) {
    showError("That doesn't look like a domain name.");
    return;
  }

  var xhr = new XMLHttpRequest();
  xhr.open("POST", "/submit/" + domain, true);
  xhr.onreadystatechange = handleReply;
  xhr.onerror = handleError;
  xhr.onTimeout = handleTimeout;
  xhr.timeout = 10000;
  requestedDomain = domain;
  xhr.send(null);
}

function handleReply(progress) {
  var xhr = progress.target;

  if (xhr.readyState != 4) {
    return;
  }

  if (xhr.status != 200) {
    showError("Request to server returned status " + xhr.status + ".");
    return;
  }

  var j = JSON.parse(xhr.responseText);
  if (j['Error'] != undefined) {
    showError(j['Error']);
    return;
  }

  var wholeDomainsMsg = "Only whole domains can be submitted because the interaction of cookies, HSTS and user behaviour is complex and we believe that only accepting whole domains is simple enough to have clear security semantics and usually the correct choice for sites.";

  if (j['Canon'] != undefined) {
    var textInput = document.getElementById("textinput");

    textInput.value = j['Canon'];
    textInput.focus();

    showMessage(wholeDomainsMsg + " (Based on public-suffix lists, " + requestedDomain + " is a subdomain of " + j['Canon'] + ".)");
    return;
  }

  if (j['Exception'] != undefined) {
    showMessage("This host failed manual review. The following message was set for it.");
    showMessage(j['Exception']);
    showMessage("You can remove this entry by clicking the button below. (This will allow you to resubmit if you so choose.)");

    var button = document.createElement('input');
    button.type = "submit";
    button.value = "Clear";
    document.getElementById("msg").appendChild(button);
    button.onclick = function(e) {
      document.getElementById("textinput").disabled = true;
      clearOutput();

      var xhr = new XMLHttpRequest();
      xhr.open("POST", "/clear/" + requestedDomain, true);
      xhr.onreadystatechange = handleClearReply;
      xhr.onerror = handleError;
      xhr.onTimeout = handleTimeout;
      xhr.timeout = 10000;
      xhr.send(null);
    }

    return;
  }

  if (j['IsPending']) {
    showMessage("That domain name has already been accepted and is pending review. Note that review can take several weeks.");
    return;
  }

  if (j['IsPreloaded']) {
    showMessage("That domain name is already preloaded! If you don't see it, note that changes follow the usual canary, dev, beta, stable progression and so can take several months to reach a stable release.");
    return;
  }

  if (j['NoHeader']) {
    showMessage("No HSTS header was found on that domain. See below about the requirements for preloading.");
    if (j['WasRedirect']) {
      showMessage("Note that the request resulted in a redirect. Ensure that the redirect itself has the HSTS header and not just the target page.");
    }
    return;
  }

  var bad = false;

  if (j['NoPreload']) {
    showMessage("The HSTS header on that site doesn't include a preload token. This is a non-standard token but it's used to authenticate the preload request.");
    bad = true;
  }

  if (j['MaxAge'] != undefined && j['MaxAge'] < 10886400) {
    showMessage("The max-age in the HSTS header is too short. It's currently " + j['MaxAge'] + " seconds, but it needs to be at least eighteen weeks (10886400 seconds).");
    bad = true;
  }

  if (j['NoSubdomains']) {
    showMessage("The includeSubdomains token is missing from the HSTS header. " + wholeDomainsMsg);
    bad = true;
  }

  if (bad) {
    showMessage("Fix the HSTS header and try again.");
    return;
  }

  if (j['Accepted']) {
    showMessage("Thank you! That domain has been queued for review. Review can take several weeks. You can check the status by entering the same domain again in the future.");

    var p = document.createElement('p');
    p.innerHTML = "Next, <a href=\"https://www.ssllabs.com/ssltest/analyze.html?d=" + requestedDomain + "\">check your HTTPS configuration</a> and fix any issues!";
    document.getElementById("msg").appendChild(p);

    document.getElementById("textinput").value = "";
    return;
  }

  showError("Bad reply from server");
}

function handleTimeout(xhr) {
  showError("Request timed out.");
}

function handleError(xhr) {
  showError("Request to server failed.");
}

function handleClearReply(progress) {
  var xhr = progress.target;

  if (xhr.readyState != 4) {
    return;
  }

  if (xhr.status != 200) {
    showError("Request to server returned status " + xhr.status + ".");
    return;
  }

  showMessage("Entry deleted");
}

function clearOutput() {
  var msgDiv = document.getElementById("msg");
  while (msgDiv.hasChildNodes()) {
    msgDiv.removeChild(msgDiv.lastChild);
  }
  document.getElementById("error").textContent = "";
}

function showError(msg) {
  document.getElementById("error").textContent = "Sorry! " + msg;
  document.getElementById("textinput").disabled = false;
}

function showMessage(msg) {
  var p = document.createElement('p');
  p.textContent = msg;
  document.getElementById("msg").appendChild(p);
  document.getElementById("textinput").disabled = false;
}
</script>

</body>
</html>